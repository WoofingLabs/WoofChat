<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>WoofChat - GateLayer</title>
    <style>
        :root{--o:#ff9100;--d:#0f0f0f;--g:#1a1d21;--l:#f5f5f7;--s:#ffe082;--r:#ffffff;--shadow:0 8px 32px rgba(255,145,0,.3)}
        *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,Arial,sans-serif}
        html,body,#app{height:100%;width:100%;overflow:hidden;background:#000}
        #app{display:flex;flex-direction:column;background:var(--d);color:#fff}
        @media(min-width:768px){#app{flex-direction:row;border-radius:20px;margin:20px;box-shadow:var(--shadow);max-width:1100px;max-height:95vh;overflow:hidden}}
        
        /* 侧边栏 */
        .sidebar{width:100%;background:var(--g);padding:16px 12px;display:flex;flex-direction:column;gap:14px;flex-shrink:0}
        @media(min-width:768px){.sidebar{width:300px;padding:20px}}
        .logo{background:linear-gradient(135deg,var(--o),#e68a00);padding:16px 20px;border-radius:16px;text-align:center;font-weight:900;font-size:1.5em;letter-spacing:1px;box-shadow:0 4px 15px rgba(255,145,0,.4)}
        
        /* 钱包按钮 */
        .wallet-btn{background:var(--o);color:#fff;border:none;padding:14px;border-radius:14px;font-weight:bold;font-size:1.1em;cursor:pointer;box-shadow:0 4px 15px rgba(255,145,0,.3);transition:.2s}
        .wallet-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(255,145,0,.5)}
        .status{font-size:.9em;opacity:.8;padding:8px 0;text-align:center}
        
        /* 代币按钮 */
        .tokens{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:10px 0}
        .token-btn{background:#2a2d33;color:#fff;border:2px solid #333;padding:10px 6px;border-radius:12px;font-weight:bold;font-size:.85em;cursor:pointer;transition:.2s}
        .token-btn.active{border-color:var(--o);background:#332200;box-shadow:0 0 15px rgba(255,145,0,.5);transform:scale(1.05)}
        
        /* 功能按钮 */
        .btn{background:var(--o);color:#fff;border:none;padding:12px;border-radius:12px;font-weight:bold;cursor:pointer;margin:4px 0;transition:.2s}
        .btn:hover{opacity:.9;transform:translateY(-1px)}
        
        /* 群组列表 */
        .groups{flex:1;overflow-y:auto;margin-top:10px}
        .group{background:#25282d;padding:12px;border-radius:12px;cursor:pointer;margin:8px 0;transition:.2s;border:1px solid #333}
        .group:hover{background:#2d3038;transform:translateY(-2px)}
        .group-name{font-weight:bold;font-size:1.1em}
        .group-info{font-size:.8em;opacity:.8;margin-top:4px}
        
        /* 聊天区 */
        .chat{flex:1;display:flex;flex-direction:column;background:var(--l);color:#333;position:relative}
        .chat-header{background:var(--o);color:#fff;padding:14px 20px;font-weight:bold;font-size:1.3em;display:flex;align-items:center;gap:12px;border-radius:16px 16px 0 0}
        .chat-header span{margin-left:auto;font-size:.9em;opacity:.9}
        
        /* 消息区 */
        .messages{flex:1;padding:16px;overflow-y:auto;background:linear-gradient(#f0f0f0,#e8e8e8)}
        .msg{max-width:78%;margin:12px 0;padding:11px 16px;border-radius:18px;position:relative;word-break:break-all}
        .sent{background:var(--s);align-self:flex-end;border-bottom-right-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .recv{background:var(--r);align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .sender{font-size:.8em;color:#666;margin-bottom:6px;display:flex;align-items:center;gap:6px;font-weight:600}
        .time{font-size:.7em;color:#999;margin-top:6px;opacity:.8}
        
        /* 输入栏 */
        .input-bar{display:flex;padding:12px;background:#fff;border-top:1px solid #ddd;position:sticky;bottom:0}
        .input-bar input{flex:1;padding:14px 18px;border:none;border-radius:25px;background:#eee;outline:none;font-size:1em}
        .input-bar button{padding:0 22px;border-radius:25px}
        
        /* 弹窗 */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:999;backdrop-filter:blur(8px)}
        .modal.show{display:flex}
        .box{background:#1a1d21;padding:28px;border-radius:20px;width:90%;max-width:420px;border:2px solid var(--o);box-shadow:0 10px 40px rgba(255,145,0,.4)}
        .box h3{color:var(--o);margin-bottom:16px;text-align:center;font-size:1.4em}
        .box input{width:100%;padding:14px;margin:10px 0;border:none;border-radius:12px;background:#2a2d33;color:#fff;font-size:1em}
        .box .info{margin:12px 0;color:#ff9100;font-size:.95em;text-align:center}
        
        /* VIP 徽章 */
        .vip{display:inline-block;width:20px;height:20px;background:center/contain no-repeat;margin-left:6px}
        .vip1{background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="42" fill="%2348a0ff"/><text x="50" y="68" font-size="60" text-anchor="middle" fill="white">1</text></svg>')}
        .vip2{background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="42" fill="%23ff6b35"/><text x="50" y="68" font-size="60" text-anchor="middle" fill="white">2</text></svg>')}
        .vip3{background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="42" fill="%23f9c440"/><text x="50" y="68" font-size="60" text-anchor="middle" fill="white">3</text></svg>')}
    </style>
</head>
<body>
<div id="app">
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="logo">WOOFCHAT</div>
        <button class="wallet-btn" id="connect">Connect Wallet</button>
        <div class="status" id="status">点击连接 GateLayer</div>

        <!-- 5 个代币大按钮 -->
        <div class="tokens">
            <button class="token-btn" data-token="0xf6d9cf57e20ba0d33372e8998a9424aa53411e04">GDOG</button>
            <button class="token-btn" data-token="0x614025d5b75a1e762111d4b845633728774d888a">MIMA</button>
            <button class="token-btn" data-token="0xe6c3567e5687340f35437e0aa5b351f23d0069d5">GING</button>
            <button class="token-btn" data-token="0x284938c2a0ae7bdca8563270134850bfb51a9332">GN</button>
            <button class="token-btn" data-token="0x01ec580a60dbf3c8f3e00805c5489037eff35675">GCAT</button>
        </div>

        <button class="btn" id="create">Create Group</button>
        <button class="btn" onclick="openModal('join')">Join Group</button>
        <button class="btn" onclick="openModal('nick')">Set Nickname</button>

        <div class="groups" id="groupList">
            <!-- 群组动态加载 -->
        </div>
    </div>

    <!-- 聊天区 -->
    <div class="chat">
        <div class="chat-header">
            <span id="chatName">选择一个群聊</span>
            <span id="memberCount">0 人</span>
        </div>
        <div class="messages" id="messages"></div>
        <div class="input-bar">
            <input type="text" id="input" placeholder="说点啥...">
            <button class="btn" id="send">Send</button>
        </div>
    </div>
</div>

<!-- 创建群 -->
<div class="modal" id="create">
    <div class="box">
        <h3>Create Group</h3>
        <input placeholder="群名（最长20字）" id="groupName">
        <input placeholder="入群费（单位：代币）" id="joinFee" value="10">
        <div class="info">当前代币: <span id="selectedToken">未选择</span></div>
        <button class="btn" onclick="createGroup()">创建</button>
        <button class="btn" onclick="closeModal('create')" style="background:#666;margin-top:8px;">取消</button>
        <div id="createStatus" style="margin-top:12px;color:#ff6b6b;"></div>
    </div>
</div>

<!-- 加入群 -->
<div class="modal" id="join">
    <div class="box">
        <h3>Join Group</h3>
        <input placeholder="输入群 ID" id="groupId">
        <div class="info" id="joinInfo"></div>
        <button class="btn" onclick="joinGroup()">加入</button>
        <button class="btn" onclick="closeModal('join')" style="background:#666;">取消</button>
        <div id="joinStatus"></div>
    </div>
</div>

<!-- 设置昵称 -->
<div class="modal" id="nick">
    <div class="box">
        <h3>Set Nickname（仅一次）</h3>
        <input placeholder="昵称（最长12字）" id="nickname">
        <button class="btn" onclick="setNickname()">保存</button>
        <button class="btn" onclick="closeModal('nick')" style="background:#666;">取消</button>
        <div id="nickStatus"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
<script>
    const CONTRACT = "0xe187C070991013a1Ae1555c32578BD093E1461dc";
    const ABI = [ /* 你的完整 ABI，粘贴这里 */ ];
    const TOKENS = {
        "0xf6d9cf57e20ba0d33372e8998a9424aa53411e04": "GDOG",
        "0x614025d5b75a1e762111d4b845633728774d888a": "MIMA",
        "0xe6c3567e5687340f35437e0aa5b351f23d0069d5": "GING",
        "0x284938c2a0ae7bdca8563270134850bfb51a9332": "GN",
        "0x01ec580a60dbf3c8f3e00805c5489037eff35675": "GCAT"
    };
    const GATE = { chainId: "0x2748", chainName: "GateLayer", nativeCurrency: { name: "GT", symbol: "GT", decimals: 18 }, rpcUrls: ["https://gatelayer-mainnet.gatenode.cc/"], blockExplorerUrls: ["https://www.gatescan.org/gatelayer"] };

    let provider, signer, contract, account, currentGroup = null, selectedToken = null;

    // 完整 ABI（精简版，实际用你最后那版）
    const FULL_ABI = [
        "function groups(uint256) view returns (string name, address creator, address paymentToken, uint256 joinFee, uint256 memberCount)",
        "function getMessages(uint256,uint256,uint256) view returns (tuple(address sender,string content,uint256 timestamp)[])",
        "function getUserJoinedGroups(address) view returns (uint256[])",
        "function getNickname(address) view returns (string)",
        "function getVIP(address) view returns (uint8)",
        "function createGroup(string,address,uint256)",
        "function joinGroup(uint256)",
        "function sendMessage(uint256,string)",
        "function setNickname(string)",
        "event MessageSent(uint256 indexed,address indexed,string)",
        "event MemberJoined(uint256 indexed,address)",
        "event GroupCreated(uint256,string,address)",
        "event NicknameUpdated(address,string,bool)",
        "event VIPSet(address indexed,uint8)"
    ];

    async function connect() {
        if (!window.ethereum) return alert("请安装 MetaMask");
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        account = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT, FULL_ABI, signer);

        const net = await provider.getNetwork();
        if (net.chainId !== 10088n) {
            try { await ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: GATE.chainId }] });
            } catch { await ethereum.request({ method: "wallet_addEthereumChain", params: [GATE] }); }
        }

        document.getElementById("connect").innerHTML = `${account.slice(0,6)}...${account.slice(-4)}`;
        document.getElementById("status").innerText = "GateLayer 已连接";
        updateNickname();
        loadGroups();
        setupEvents();
    }

    function updateTokenSelection() {
        document.querySelectorAll(".token-btn").forEach(btn => {
            btn.classList.toggle("active", btn.dataset.token === selectedToken);
        });
        document.getElementById("selectedToken").innerText = selectedToken ? TOKENS[selectedToken] : "未选择";
    }

    document.querySelectorAll(".token-btn").forEach(btn => {
        btn.onclick = () => {
            selectedToken = btn.dataset.token;
            updateTokenSelection();
        };
    });

    async function updateNickname() {
        const nick = await contract.getNickname(account).catch(() => "");
        if (nick) document.getElementById("connect").innerHTML += ` (${nick})`;
    }

    async function loadGroups() {
        const ids = await contract.getUserJoinedGroups(account);
        const list = document.getElementById("groupList");
        list.innerHTML = ids.length ? "" : "<div style='text-align:center;opacity:.6;padding:20px'>暂无群聊</div>";
        for (let id of ids) {
            const g = await contract.groups(id);
            const sym = TOKENS[g.paymentToken] || "GT";
            const div = document.createElement("div");
            div.className = "group";
            div.innerHTML = `
                <div class="group-name">${g.name}</div>
                <div class="group-info">${g.memberCount} 人 · ${ethers.formatEther(g.joinFee)} ${sym}</div>
            `;
            div.onclick = () => selectGroup(id);
            list.appendChild(div);
        }
    }

    async function selectGroup(id) {
        currentGroup = id;
        const g = await contract.groups(id);
        document.getElementById("chatName").innerText = g.name;
        document.getElementById("memberCount").innerText = g.memberCount + " 人";
        loadMessages();
    }

    async function loadMessages() {
        if (!currentGroup) return;
        const msgs = await contract.getMessages(currentGroup, 0, 100);
        const container = document.getElementById("messages");
        container.innerHTML = "";
        for (let m of msgs) {
            const nick = await contract.getNickname(m.sender).catch(() => m.sender.slice(0,8));
            const vip = await contract.getVIP(m.sender).catch(() => 0);
            const badge = vip ? `<span class="vip vip${vip}"></span>` : "";
            const div = document.createElement("div");
            div.className = `msg ${m.sender === account ? "sent" : "recv"}`;
            div.innerHTML = `
                <div class="sender">${nick}${badge}</div>
                <div>${m.content}</div>
                <div class="time">${new Date(m.timestamp*1000).toLocaleTimeString()}</div>
            `;
            container.appendChild(div);
        }
        container.scrollTop = container.scrollHeight;
    }

    async function createGroup() {
        if (!selectedToken) return alert("请先选择代币！");
        const name = document.getElementById("groupName").value.trim();
        const fee = document.getElementById("joinFee").value;
        if (!name || !fee) return alert("请填写完整");
        document.getElementById("createStatus").innerText = "创建中...";
        try {
            const tx = await contract.createGroup(name, selectedToken, ethers.parseEther(fee));
            await tx.wait();
            document.getElementById("createStatus").innerText = "创建成功！";
            loadGroups();
            closeModal("create");
        } catch (e) {
            document.getElementById("createStatus").innerText = "失败: " + e.message;
        }
    }

    async function joinGroup() {
        const id = document.getElementById("groupId").value;
        if (!id) return;
        const g = await contract.groups(id);
        const sym = TOKENS[g.paymentToken] || "GT";
        document.getElementById("joinInfo").innerText = `费用: ${ethers.formatEther(g.joinFee)} ${sym}`;
        if (g.paymentToken !== ethers.ZeroAddress) {
            const erc20 = new ethers.Contract(g.paymentToken, ["function approve(address,uint256) returns (bool)"], signer);
            await (await erc20.approve(CONTRACT, g.joinFee)).wait();
        }
        await contract.joinGroup(id);
        document.getElementById("joinStatus").innerText = "加入成功！";
        loadGroups();
        closeModal("join");
    }

    async function setNickname() {
        const n = document.getElementById("nickname").value.trim();
        if (!n) return;
        await contract.setNickname(n);
        document.getElementById("nickStatus").innerText = "昵称已设置！";
        updateNickname();
        closeModal("nick");
    }

    function openModal(id) { document.getElementById(id).classList.add("show"); }
    function closeModal(id) { document.getElementById(id).classList.remove("show"); }
    function sendMessage() {
        const txt = document.getElementById("input").value.trim();
        if (!txt || !currentGroup) return;
        contract.sendMessage(currentGroup, txt);
        document.getElementById("input").value = "";
    }

    function setupEvents() {
        contract.on("MessageSent", (id) => { if (currentGroup === id) loadMessages(); });
        contract.on("MemberJoined", loadGroups);
        contract.on("GroupCreated", loadGroups);
        contract.on("NicknameUpdated", updateNickname);
    }

    // 初始化
    document.getElementById("connect").onclick = connect;
    document.getElementById("create").onclick = () => openModal("create");
    document.getElementById("send").onclick = sendMessage;
    document.getElementById("input").onkeydown = e => e.key === "Enter" && sendMessage();
</script>
</body>
</html>
