<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>WoofChat - GateLayer</title>
    <style>
        :root{--o:#ff9100;--d:#0f0f0f;--g:#1a1d21;--l:#f5f5f7;--s:#ffe082;--r:#fff}
        *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,Arial,sans-serif}
        html,body,#app{height:100%;width:100%;overflow:hidden;background:#000;display:flex;justify-content:center;align-items:center}
        #app{max-width:1100px;width:100%;height:100vh;background:var(--d);box-shadow:0 0 40px rgba(255,145,0,.4);display:flex;flex-direction:column;overflow:hidden}
        @media(min-width:768px){#app{border-radius:24px;height:95vh;flex-direction:row}}
        
        /* 侧边栏 */
        .sidebar{width:100%;background:var(--g);padding:16px;display:flex;flex-direction:column;gap:14px;flex-shrink:0}
        @media(min-width:768px){.sidebar{width:320px;padding:24px}}
        .logo{background:linear-gradient(135deg,var(--o),#e68a00);padding:18px;border-radius:18px;text-align:center;font-weight:900;font-size:1.6em;letter-spacing:2px;box-shadow:0 6px 20px rgba(255,145,0,.5)}
        
        /* 钱包 */
        .wallet{background:var(--o);color:#fff;border:none;padding:16px;border-radius:16px;font-weight:bold;font-size:1.1em;cursor:pointer;box-shadow:0 6px 20px rgba(255,145,0,.4);transition:.2s}
        .wallet:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(255,145,0,.6)}
        .status{font-size:.9em;opacity:.8;text-align:center;margin:8px 0}
        
        /* 5 个代币按钮 */
        .tokens{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:12px 0}
        .token{background:#2a2d33;color:#fff;border:2px solid #444;padding:12px 8px;border-radius:14px;font-weight:bold;font-size:.9em;cursor:pointer;transition:.2s;text-align:center}
        .token.active{border:3px solid var(--o);background:#331800;box-shadow:0 0 20px rgba(255,145,0,.6);transform:scale(1.08)}
        
        /* 功能按钮 */
        .btn{background:var(--o);color:#fff;border:none;padding:14px;border-radius:14px;font-weight:bold;cursor:pointer;margin:6px 0;transition:.2s;font-size:1em}
        .btn:hover{opacity:.9;transform:translateY(-2px)}
        .btn:disabled{background:#555;cursor:not-allowed;opacity:.6}
        
        /* 群组 */
        .groups{flex:1;overflow-y:auto;padding-top:8px}
        .group{background:#25282d;padding:14px;border-radius:14px;cursor:pointer;margin:8px 0;transition:.2s;border:1px solid #333}
        .group:hover{background:#2f323a;transform:translateY(-3px);box-shadow:0 6px 15px rgba(0,0,0,.3)}
        .gname{font-weight:bold;font-size:1.1em;color:#fff}
        .ginfo{font-size:.85em;opacity:.8;margin-top:6px}
        
        /* 聊天区 */
        .chat{flex:1;display:flex;flex-direction:column;background:var(--l);color:#333}
        .header{background:var(--o);color:#fff;padding:16px 24px;font-weight:bold;font-size:1.4em;display:flex;align-items:center;gap:12px}
        .header span{margin-left:auto;font-size:.9em;opacity:.9}
        .msgs{flex:1;padding:16px;overflow-y:auto;background:linear-gradient(#eee,#e0e0e0)}
        .msg{max-width:78%;margin:12px 0;padding:12px 18px;border-radius:20px;position:relative;word-break:break-all}
        .sent{background:var(--s);align-self:flex-end;border-bottom-right-radius:4px;box-shadow:0 3px 10px rgba(0,0,0,.15)}
        .recv{background:var(--r);align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 3px 10px rgba(0,0,0,.15)}
        .sender{font-size:.85em;color:#555;margin-bottom:6px;display:flex;align-items:center;gap:6px;font-weight:600}
        .time{font-size:.75em;color:#888;margin-top:6px}
        
        /* 输入栏 */
        .bar{display:flex;padding:14px;background:#fff;border-top:1px solid #ddd;position:sticky;bottom:0}
        .bar input{flex:1;padding:16px 20px;border:none;border-radius:30px;background:#eee;outline:none;font-size:1.1em}
        .bar button{padding:0 26px;border-radius:30px;font-size:1.1em}
        
        /* 弹窗 */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:999;backdrop-filter:blur(10px)}
        .modal.show{display:flex}
        .box{background:#1a1d21;padding:32px;border-radius:24px;width:90%;max-width:440px;border:3px solid var(--o);box-shadow:0 15px 50px rgba(255,145,0,.5)}
        .box h3{color:var(--o);margin-bottom:20px;text-align:center;font-size:1.6em}
        .box input{width:100%;padding:16px;margin:12px 0;border:none;border-radius:14px;background:#2a2d33;color:#fff;font-size:1.1em}
        .box .info{margin:14px 0;color:#ff9100;font-size:1em;text-align:center;font-weight:bold}
        
        /* VIP */
        .vip{width:22px;height:22px;background:center/contain no-repeat;margin-left:6px;display:inline-block}
        .vip1{background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="44" fill="%2348a0ff"/><text x="50" y="70" font-size="60" text-anchor="middle" fill="white">1</text></svg>')}
        .vip2{background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="44" fill="%23ff6b35"/><text x="50" y="70" font-size="60" text-anchor="middle" fill="white">2</text></svg>')}
        .vip3{background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="44" fill="%23f9c440"/><text x="50" y="70" font-size="60" text-anchor="middle" fill="white">3</text></svg>')}
    </style>
</head>
<body>
<div id="app">
    <div class="sidebar">
        <div class="logo">WOOFCHAT</div>
        <button class="wallet" id="connect">Connect Wallet</button>
        <div class="status" id="status">点击连接 GateLayer</div>

        <div class="tokens">
            <div class="token" data-token="0xf6d9cf57e20ba0d33372e8998a9424aa53411e04">GDOG</div>
            <div class="token" data-token="0x614025d5b75a1e762111d4b845633728774d888a">MIMA</div>
            <div class="token" data-token="0xe6c3567e5687340f35437e0aa5b351f23d0069d5">GING</div>
            <div class="token" data-token="0x284938c2a0ae7bdca8563270134850bfb51a9332">GN</div>
            <div class="token" data-token="0x01ec580a60dbf3c8f3e00805c5489037eff35675">GCAT</div>
        </div>

        <button class="btn" id="create">Create Group</button>
        <button class="btn" onclick="openModal('join')">Join Group</button>
        <button class="btn" onclick="openModal('nick')">Set Nickname</button>

        <div class="groups" id="groupList"></div>
    </div>

    <div class="chat">
        <div class="header">
            <span id="chatName">选择群聊</span>
            <span id="memberCount">0 人</span>
        </div>
        <div class="msgs" id="messages"></div>
        <div class="bar">
            <input type="text" id="input" placeholder="说点啥...">
            <button class="btn" id="send">Send</button>
        </div>
    </div>
</div>

<!-- 创建群 -->
<div class="modal" id="create">
    <div class="box">
        <h3>创建群聊</h3>
        <input placeholder="群名（≤20字）" id="groupName">
        <input placeholder="入群费（例如：10）" id="joinFee" value="10">
        <div class="info">当前代币: <span id="selectedToken">未选择</span></div>
        <button class="btn" id="createBtn">创建群聊</button>
        <button class="btn" onclick="closeModal('create')" style="background:#666;margin-top:10px;">取消</button>
        <div id="createStatus" style="margin-top:14px;color:#ff6b6b;font-weight:bold;"></div>
    </div>
</div>

<!-- 加入群 / 昵称 同上，略... -->
<div class="modal" id="join">...</div>
<div class="modal" id="nick">...</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
<script>
    const CONTRACT = "0xe187C070991013a1Ae1555c32578BD093E1461dc";
    const ABI = [ /* 你的完整 ABI */ ];
    const TOKENS = { /* 同上 5 个地址 */ };
    const GATE = { /* 同上 */ };
    let provider, signer, contract, account, currentGroup = null, selectedToken = null;

    async function connect() {
        if (!window.ethereum) return alert("请安装 MetaMask");
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        account = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT, ABI, signer);

        // 切换网络
        const net = await provider.getNetwork();
        if (net.chainId !== 10088n) {
            try { await ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0x2748" }] });
            } catch { await ethereum.request({ method: "wallet_addEthereumChain", params: [GATE] }); }
        }

        document.getElementById("connect").innerHTML = `${account.slice(0,6)}...${account.slice(-4)}`;
        document.getElementId("status").innerText = "GateLayer 已连接";
        updateNickname();
        loadGroups();
        setupEvents();
    }

    // 代币高亮
    document.querySelectorAll(".token").forEach(t => {
        t.onclick = () => {
            selectedToken = t.dataset.token;
            document.querySelectorAll(".token").forEach(x => x.classList.toggle("active", x === t));
            document.getElementById("selectedToken").innerText = TOKENS[selectedToken];
        };
    });

    // 创建群（关键修复！）
    document.getElementById("createBtn").onclick = async () => {
        if (!selectedToken) return alert("请先选择代币！");
        const name = document.getElementById("groupName").value.trim();
        const fee = document.getElementById("joinFee").value;
        if (!name || !fee) return alert("请填写完整");

        document.getElementById("createStatus").innerText = "创建中...";
        try {
            const tx = await contract.createGroup(
                name,
                selectedToken,
                ethers.parseUnits(fee, 18)  // 18 位小数！
            );
            await tx.wait();
            document.getElementById("createStatus").innerText = "创建成功！";
            loadGroups();
            closeModal("create");
        } catch (e) {
            document.getElementById("createStatus").innerText = "失败: " + e.message;
        }
    };

    // 其他函数（loadGroups / joinGroup / sendMessage）保持不变
    // ...（省略 100 行，逻辑与之前一致）

    document.getElementById("connect").onclick = connect;
    document.getElementById("create").onclick = () => openModal("create");
</script>
</body>
</html>
